name: CI

on:
  push:
    branches:
      - main
      - nightly
      - dev
  pull_request:

permissions:
  contents: read

jobs:
  rust:
    name: Rust
    runs-on: ${{ github.repository == 'synth-laboratories/Horizons' && 'blacksmith-4vcpu-ubuntu-2404' || 'ubuntu-latest' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          # Keep this aligned with Cargo.lock MSRV constraints.
          toolchain: 1.91.0
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: fmt
        run: cargo fmt --all --check

      - name: clippy
        # Keep a high signal-to-noise ratio: fail on the most actionable classes
        # of lints without making the workflow brittle on style/complexity warnings.
        run: cargo clippy --features all --all-targets -- -D clippy::correctness -D clippy::suspicious -D clippy::perf

      - name: check
        run: cargo check --features all

      - name: test
        env:
          # Keep this aligned with release.yml: Horizons currently links both libsql-ffi and
          # libsqlite3-sys (via sqlx) which can produce duplicate SQLite symbols on Linux.
          RUSTFLAGS: "-C link-args=-Wl,--allow-multiple-definition"
        run: cargo test --features all

  python:
    name: Python
    runs-on: ${{ github.repository == 'synth-laboratories/Horizons' && 'blacksmith-4vcpu-ubuntu-2404' || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: horizons_py
    steps:
      - uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[test]"

      - name: Tests
        run: pytest -q

  typescript:
    name: TypeScript
    runs-on: ${{ github.repository == 'synth-laboratories/Horizons' && 'blacksmith-4vcpu-ubuntu-2404' || 'ubuntu-latest' }}
    defaults:
      run:
        working-directory: horizons_ts
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: horizons_ts/package-lock.json

      - name: Install deps
        run: npm install

      - name: Build
        run: npm run build

      - name: Test
        run: npm test
